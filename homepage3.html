<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alertas de IncÃªndio</title>
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-pulse-custom {
            animation: pulse-bg 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-bg {
            0%, 100% { background-color: rgba(254, 226, 226, 0.8); }
            50% { background-color: rgba(254, 226, 226, 0.4); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div id="novo-alerta-banner" class="hidden bg-red-600 text-white font-bold text-center py-4 px-6 flex items-center justify-between shadow-lg">
        <div class="flex items-center gap-4">
            <span class="text-2xl">ðŸš¨</span>
            <span id="banner-mensagem" class="text-lg">Novo alerta de incÃªndio recebido!</span>
        </div>
        <button onclick="dismissBanner()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-1 px-4 rounded-full transition-colors duration-200">
            OK
        </button>
    </div>

    <div class="container mx-auto p-4 flex-grow">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-5xl mx-auto">
            <h1 class="text-4xl font-extrabold text-gray-800 text-center mb-6 border-b-2 border-red-500 pb-4 flex items-center justify-center gap-4">
                <span class="text-red-500">ðŸ”¥</span> Alertas de IncÃªndio
            </h1>
            <p class="text-gray-600 mb-6 text-center">
                VisualizaÃ§Ã£o de alertas de incÃªndio confirmados pela inteligÃªncia artificial.
            </p>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-xl shadow-md overflow-hidden">
                    <thead class="bg-red-600 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left font-bold tracking-wider">MÃ³dulo</th>
                            <th class="py-3 px-4 text-left font-bold tracking-wider">DescriÃ§Ã£o</th>
                            <th class="py-3 px-4 text-left font-bold tracking-wider">Data e Hora</th>
                            <th class="py-3 px-4 text-left font-bold tracking-wider">LocalizaÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-800 divide-y divide-gray-200">
                        {% if alertas %}
                            {% for alerta in alertas %}
                            {% if loop.first %}
                            <tr class="bg-red-200 border-l-4 border-red-500 animate-pulse-custom">
                            {% else %}
                            <tr class="bg-red-50 hover:bg-red-100 transition-colors duration-200">
                            {% endif %}
                                <td class="py-4 px-4 whitespace-nowrap">{{ alerta.nome_modulo }}</td>
                                <td class="py-4 px-4 whitespace-nowrap">{{ alerta.descricao }}</td>
                                <td class="py-4 px-4 whitespace-nowrap">{{ alerta.data_hora.strftime('%d/%m/%Y %H:%M:%S') }}</td>
                                <td class="py-4 px-4 whitespace-nowrap">{{ alerta.latitude }}, {{ alerta.longitude }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="py-8 px-4 text-center text-gray-500 bg-gray-50">
                                    <div class="flex flex-col items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-green-500 mb-2" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                        </svg>
                                        <span class="text-xl font-semibold">Nenhum alerta de incÃªndio crÃ­tico no momento.</span>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-8">
                <a href="/leituras" class="inline-block bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200">
                    Ir para Dashboard de Leituras
                </a>
            </div>
        </div>
    </div>
    <script>
        const banner = document.getElementById('novo-alerta-banner');
        let ultimaDataAlerta = null;

        function dismissBanner() {
            banner.classList.add('hidden');
        }

        // FunÃ§Ã£o para interpretar a data brasileira DD/MM/YYYY HH:mm:ss
        function parseDataBrasileira(dataStr) {
            const [data, hora] = dataStr.split(" ");
            const [dia, mes, ano] = data.split("/").map(Number);
            const [h, m, s] = hora.split(":").map(Number);
            return new Date(ano, mes - 1, dia, h, m, s);
        }

        // Verifica novos alertas usando /modulos.json
        function verificarNovosAlertas() {
            fetch('/modulos.json')
                .then(response => response.json())
                .then(modulos => {
                    if (modulos && modulos.length > 0) {
                        let ultimo = modulos.reduce((maisRecente, atual) => {
                            const dataMaisRecente = parseDataBrasileira(maisRecente.ultima_atualizacao);
                            const dataAtual = parseDataBrasileira(atual.ultima_atualizacao);
                            return dataAtual > dataMaisRecente ? atual : maisRecente;
                        });

                        if (ultimo.ultima_atualizacao !== ultimaDataAlerta) {
                            ultimaDataAlerta = ultimo.ultima_atualizacao;
                            banner.classList.remove('hidden');
                            document.getElementById('banner-mensagem').textContent =
                                `ðŸš¨ Novo alerta do ${ultimo.nome_modulo}: ${ultimo.status}`;
                        }
                    }
                })
                .catch(error => console.error('Erro ao buscar /modulos.json:', error));
        }

        // Checa a cada 5 segundos
        setInterval(verificarNovosAlertas, 5000);
    </script>
</body>
</html>
