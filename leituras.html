<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Leituras</title>
<link rel="icon" href="data:,">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            #map { height: 400px; width: 100%; }
        }
        .animate-pulse-custom {
            animation: pulse-bg 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-bg {
            0%, 100% { background-color: rgba(254, 226, 226, 0.8); }
            50% { background-color: rgba(254, 226, 226, 0.4); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
<div class="container mx-auto p-4 flex-grow">
  <div class="bg-white rounded-2xl shadow-xl p-8 max-w-5xl mx-auto">
    <h1 class="text-4xl font-extrabold text-gray-800 text-center mb-6 border-b-2 border-red-500 pb-4 flex items-center justify-center gap-4">
      Dashboard de Monitoramento
    </h1>
    <p class="text-gray-600 mb-6 text-center">
      Estado atual dos módulos com base nas últimas leituras.
    </p>
    <div class="overflow-x-auto mb-8">
      <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
        <thead class="bg-red-600 text-white">
          <tr>
            <th class="py-3 px-4 text-left font-bold tracking-wider">Módulo</th>
            <th class="py-3 px-4 text-left font-bold tracking-wider">Status dos sensores</th>
            <th class="py-3 px-4 text-left font-bold tracking-wider">Última Atualização</th>
          </tr>
        </thead>
        <tbody id="tabela-modulos" class="text-gray-800 divide-y divide-gray-200">
        </tbody>
      </table>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
      <h2 class="text-3xl font-extrabold text-gray-800 text-center mb-6 border-b-2 border-red-500 pb-4 flex items-center justify-center gap-4">
        Localização dos Módulos
      </h2>
      <div id="map" class="rounded-lg shadow-lg"></div>
    </div>

    <p class="text-center mt-8">
     <a href="/" class="inline-block bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200">
       Ir para Página de Alertas
     </a>
    </p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const map = L.map('map').setView([-23.55, -46.63], 14);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const tabela = document.getElementById('tabela-modulos');
  let markers = [];

  async function atualizarDashboard() {
    try {
      const response = await fetch('/modulos.json');
      const modulos = await response.json();
      console.log("Dados recebidos:", modulos);

      // Limpa tabela
      tabela.innerHTML = '';

      // Remove marcadores antigos
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      modulos.forEach(modulo => {
        // Preenche tabela
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-4 px-4 whitespace-nowrap">${modulo.nome_modulo}</td>
          <td class="py-4 px-4 whitespace-nowrap">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
              ${modulo.status === 'Detectado' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
              ${modulo.status}
            </span>
          </td>
          <td class="py-4 px-4 whitespace-nowrap">${modulo.ultima_atualizacao}</td>
        `;
        tabela.appendChild(tr);

        // Adiciona marcador no mapa, somente se lat/lng válidos
        if (modulo.latitude != null && modulo.longitude != null) {
          const marker = L.marker([modulo.latitude, modulo.longitude]).addTo(map);
          marker.bindPopup(`<b>${modulo.nome_modulo}</b><br>Status: ${modulo.status}<br>Última atualização: ${modulo.ultima_atualizacao}`);
          markers.push(marker);
        }
      });

      // Centraliza o mapa nos marcadores
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }

    } catch (error) {
      console.error("Erro ao atualizar dashboard:", error);
    }
  }

  atualizarDashboard();              // Atualiza na carga da página
  setInterval(atualizarDashboard, 5000); // Atualiza a cada 5 segundos
});
</script>
</body>
</html>
